# Binary Instrumentation 1 #
 
## Overview ##

200 points

Category: [Reverse Engineering](../)

Tags: `#reverseengineering #windows #winapi #frida`

## Description ##

I have been learning to use the Windows API to do cool stuff! Can you wake up my program to get the flag?
Download the exe here. Unzip the archive with the password picoctf

## Approach ##

Having never used [frida](https://frida.re/) this application suite was completely new to me.

Installing [Python](https://www.python.org/) 3.13.2 on this fresh Windows machine and using `pip` to install frida.

    $ pip install frida-tools

We can now run [frida-trace](https://frida.re/docs/frida-trace/) from the command line.

Running the challenge binary `bininst1.exe` we see:

    D:\CTF\picoCTF-2025\Binary-Instrumentation-1>bininst1\bininst1.exe
        Hi, I have the flag for you just right here!
        I'll just take a quick nap before I print it out for you, should only take me a decade or so!
        zzzzzzzz....

From this it sounds like we should be targetting `Sleep` Win32 APIs.

Invoking `frida-trace` targetting the instrumentation to `Sleep` APIs via `-i Sleep` on our challenge binary `-f bininst1\bininst1.exe`, we see the following:

    D:\CTF\picoCTF-2025\Binary-Instrumentation-1>frida-trace -i Sleep -f bininst1\bininst1.exe
    Instrumenting...
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNEL32.DLL\Sleep.js"
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNELBASE.dll\Sleep.js"
    Started tracing 2 functions. Web UI available at http://localhost:59276/
    Hi, I have the flag for you just right here!
    I'll just take a quick nap before I print it out for you, should only take me a decade or so!
    zzzzzzzz....
               /* TID 0x55c */
        19 ms  Sleep()
        19 ms     | Sleep()

Running this for the first time creates a folder `__handlers__`, that for each Dynamic Link Library (DLL) or module, another folder is created that holds a javascript based handler for each instrumented API.

Inspecting the default `Sleep` handler `__handlers__\KERNEL32.DLL\Sleep.js` we see :

    /*
     * Auto-generated by Frida. Please modify to match the signature of Sleep.
     * This stub is currently auto-generated from manpages when available.
     *
     * For full API reference, see: https://frida.re/docs/javascript-api/
     */

    defineHandler({
      onEnter(log, args, state) {
        log('Sleep()');
      },

      onLeave(log, retval, state) {
      }
    });

Which doesn't tell us a lot, apart from we executed the `Sleep()` API call. So I modified the `onEnter()` handler to start printing the arguments to `Sleep()`, where the API call is documented as:

    void Sleep(
      [in] DWORD dwMilliseconds
    );

Modified `Sleep` handler `__handlers__\KERNEL32.DLL\Sleep.js` :

    /*
     * Auto-generated by Frida. Please modify to match the signature of Sleep.
     * This stub is currently auto-generated from manpages when available.
     *
     * For full API reference, see: https://frida.re/docs/javascript-api/
     */

    defineHandler({
      onEnter(log, args, state) {
        log('Sleep()');
        log('Sleep() - dwMilliseconds = ', args[0]);    
      },

      onLeave(log, retval, state) {
      }
    });

Running this again through `frida-trace` gave us some insight into what was meant by `"should only take me a decade or so!"` the `dwMilliseconds` parameter in the `Sleep()` call is `-2` or essentially the maximum allowable sleep duration (`-` is indefinite):

    D:\CTF\picoCTF-2025\Binary-Instrumentation-1>frida-trace -i Sleep -f bininst1\bininst1.exe
    Instrumenting...
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNEL32.DLL\Sleep.js"
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNELBASE.dll\Sleep.js"
    Started tracing 2 functions. Web UI available at http://localhost:59276/
    Hi, I have the flag for you just right here!
    I'll just take a quick nap before I print it out for you, should only take me a decade or so!
    zzzzzzzz....
               /* TID 0x55c */
        19 ms  Sleep()
        19 ms  Sleep() - dwMilliseconds =  0xfffffffe
        19 ms     | Sleep()

I did get stuck here for a little while, trying to work out how to signal the thread to wake up, until the penny dropped and I realised that `frida-trace` is not just for inspection but it can also modify the parameters to instrumented arguments within these handlers, such as `onEnter()`.

Therefore if we reduce the `dwMilliseconds` argument from `-2` to something a little more management (with my lack of patience) like say `2` milliseconds, we should arrive at our flag in no time.

## Solution ##

The modified `Sleep` handler `__handlers__\KERNEL32.DLL\Sleep.js` :

    /*
     * Auto-generated by Frida. Please modify to match the signature of Sleep.
     * This stub is currently auto-generated from manpages when available.
     *
     * For full API reference, see: https://frida.re/docs/javascript-api/
     */

    defineHandler({
      onEnter(log, args, state) {
        log('Sleep()');
        log('Sleep() - dwMilliseconds = ', args[0]);
        args[0] = ptr("0x02")
        log('Sleep() - dwMilliseconds = ', args[0]);      
      },

      onLeave(log, retval, state) {
      }
    });

Running the challenge binary again through friday produces the following output, it turns out there was not just one `Sleep(-2)` but multiple in a loop (or similar) :

    D:\CTF\picoCTF-2025\Binary-Instrumentation-1>frida-trace -i Sleep -f bininst1\bininst1.exe
    Instrumenting...
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNEL32.DLL\Sleep.js"
    Sleep: Loaded handler at "D:\CTF\picoCTF-2025\Binary-Instrumentation-1\__handlers__\KERNELBASE.dll\Sleep.js"
    Started tracing 2 functions. Web UI available at http://localhost:59276/
    Hi, I have the flag for you just right here!
    I'll just take a quick nap before I print it out for you, should only take me a decade or so!
    zzzzzzzz....
               /* TID 0x55c */
        19 ms  Sleep()
        19 ms  Sleep() - dwMilliseconds =  0xfffffffe
        19 ms  Sleep() - dwMilliseconds =  0x2
        19 ms     | Sleep()
        35 ms  Sleep()
        35 ms  Sleep() - dwMilliseconds =  0xfffffffe
        35 ms  Sleep() - dwMilliseconds =  0x2
        35 ms     | Sleep()
        54 ms  Sleep()
        54 ms  Sleep() - dwMilliseconds =  0xfffffffe
        54 ms  Sleep() - dwMilliseconds =  0x2
        54 ms     | Sleep()
        69 ms  Sleep()
        69 ms  Sleep() - dwMilliseconds =  0xfffffffe
        69 ms  Sleep() - dwMilliseconds =  0x2
        69 ms     | Sleep()
        97 ms  Sleep()
        97 ms  Sleep() - dwMilliseconds =  0xfffffffe
        97 ms  Sleep() - dwMilliseconds =  0x2
        97 ms     | Sleep()
       120 ms  Sleep()
       120 ms  Sleep() - dwMilliseconds =  0xfffffffe
       120 ms  Sleep() - dwMilliseconds =  0x2
       120 ms     | Sleep()
       135 ms  Sleep()
       135 ms  Sleep() - dwMilliseconds =  0xfffffffe
       135 ms  Sleep() - dwMilliseconds =  0x2
       135 ms     | Sleep()
       155 ms  Sleep()
       155 ms  Sleep() - dwMilliseconds =  0xfffffffe
       155 ms  Sleep() - dwMilliseconds =  0x2
       155 ms     | Sleep()
       170 ms  Sleep()
       170 ms  Sleep() - dwMilliseconds =  0xfffffffe
       170 ms  Sleep() - dwMilliseconds =  0x2
       170 ms     | Sleep()
       186 ms  Sleep()
       186 ms  Sleep() - dwMilliseconds =  0xfffffffe
       186 ms  Sleep() - dwMilliseconds =  0x2
       186 ms     | Sleep()
       202 ms  Sleep()
       202 ms  Sleep() - dwMilliseconds =  0xfffffffe
       202 ms  Sleep() - dwMilliseconds =  0x2
       202 ms     | Sleep()
       221 ms  Sleep()
       221 ms  Sleep() - dwMilliseconds =  0xfffffffe
       221 ms  Sleep() - dwMilliseconds =  0x2
       221 ms     | Sleep()
       237 ms  Sleep()
       237 ms  Sleep() - dwMilliseconds =  0xfffffffe
       237 ms  Sleep() - dwMilliseconds =  0x2
       237 ms     | Sleep()
       256 ms  Sleep()
       256 ms  Sleep() - dwMilliseconds =  0xfffffffe
       256 ms  Sleep() - dwMilliseconds =  0x2
       256 ms     | Sleep()
       272 ms  Sleep()
       272 ms  Sleep() - dwMilliseconds =  0xfffffffe
       272 ms  Sleep() - dwMilliseconds =  0x2
       272 ms     | Sleep()
       287 ms  Sleep()
       287 ms  Sleep() - dwMilliseconds =  0xfffffffe
       287 ms  Sleep() - dwMilliseconds =  0x2
       287 ms     | Sleep()
       303 ms  Sleep()
       303 ms  Sleep() - dwMilliseconds =  0xfffffffe
       303 ms  Sleep() - dwMilliseconds =  0x2
       303 ms     | Sleep()
       325 ms  Sleep()
       325 ms  Sleep() - dwMilliseconds =  0xfffffffe
       325 ms  Sleep() - dwMilliseconds =  0x2
       325 ms     | Sleep()
       347 ms  Sleep()
       347 ms  Sleep() - dwMilliseconds =  0xfffffffe
       347 ms  Sleep() - dwMilliseconds =  0x2
       347 ms     | Sleep()
       375 ms  Sleep()
       375 ms  Sleep() - dwMilliseconds =  0xfffffffe
       375 ms  Sleep() - dwMilliseconds =  0x2
       375 ms     | Sleep()
       391 ms  Sleep()
       391 ms  Sleep() - dwMilliseconds =  0xfffffffe
       391 ms  Sleep() - dwMilliseconds =  0x2
       391 ms     | Sleep()
       406 ms  Sleep()
       406 ms  Sleep() - dwMilliseconds =  0xfffffffe
       406 ms  Sleep() - dwMilliseconds =  0x2
       406 ms     | Sleep()
       426 ms  Sleep()
       426 ms  Sleep() - dwMilliseconds =  0xfffffffe
       426 ms  Sleep() - dwMilliseconds =  0x2
       426 ms     | Sleep()
       441 ms  Sleep()
       441 ms  Sleep() - dwMilliseconds =  0xfffffffe
       441 ms  Sleep() - dwMilliseconds =  0x2
       441 ms     | Sleep()
       461 ms  Sleep()
       461 ms  Sleep() - dwMilliseconds =  0xfffffffe
       461 ms  Sleep() - dwMilliseconds =  0x2
       461 ms     | Sleep()
       476 ms  Sleep()
       476 ms  Sleep() - dwMilliseconds =  0xfffffffe
       476 ms  Sleep() - dwMilliseconds =  0x2
       476 ms     | Sleep()
       492 ms  Sleep()
       492 ms  Sleep() - dwMilliseconds =  0xfffffffe
       492 ms  Sleep() - dwMilliseconds =  0x2
       492 ms     | Sleep()
       507 ms  Sleep()
       507 ms  Sleep() - dwMilliseconds =  0xfffffffe
       507 ms  Sleep() - dwMilliseconds =  0x2
       507 ms     | Sleep()
       527 ms  Sleep()
       527 ms  Sleep() - dwMilliseconds =  0xfffffffe
       527 ms  Sleep() - dwMilliseconds =  0x2
       527 ms     | Sleep()
       548 ms  Sleep()
       548 ms  Sleep() - dwMilliseconds =  0xfffffffe
       548 ms  Sleep() - dwMilliseconds =  0x2
       548 ms     | Sleep()
       578 ms  Sleep()
       578 ms  Sleep() - dwMilliseconds =  0xfffffffe
       578 ms  Sleep() - dwMilliseconds =  0x2
       578 ms     | Sleep()
       593 ms  Sleep()
       593 ms  Sleep() - dwMilliseconds =  0xfffffffe
       593 ms  Sleep() - dwMilliseconds =  0x2
       593 ms     | Sleep()
       609 ms  Sleep()
       609 ms  Sleep() - dwMilliseconds =  0xfffffffe
       609 ms  Sleep() - dwMilliseconds =  0x2
       609 ms     | Sleep()
       628 ms  Sleep()
       628 ms  Sleep() - dwMilliseconds =  0xfffffffe
       628 ms  Sleep() - dwMilliseconds =  0x2
       628 ms     | Sleep()
       648 ms  Sleep()
       648 ms  Sleep() - dwMilliseconds =  0xfffffffe
       648 ms  Sleep() - dwMilliseconds =  0x2
       648 ms     | Sleep()
       679 ms  Sleep()
       679 ms  Sleep() - dwMilliseconds =  0xfffffffe
       679 ms  Sleep() - dwMilliseconds =  0x2
       679 ms     | Sleep()
       694 ms  Sleep()
       694 ms  Sleep() - dwMilliseconds =  0xfffffffe
       694 ms  Sleep() - dwMilliseconds =  0x2
       694 ms     | Sleep()
       710 ms  Sleep()
       710 ms  Sleep() - dwMilliseconds =  0xfffffffe
       710 ms  Sleep() - dwMilliseconds =  0x2
       710 ms     | Sleep()
       729 ms  Sleep()
       729 ms  Sleep() - dwMilliseconds =  0xfffffffe
       729 ms  Sleep() - dwMilliseconds =  0x2
       729 ms     | Sleep()
       745 ms  Sleep()
       745 ms  Sleep() - dwMilliseconds =  0xfffffffe
       745 ms  Sleep() - dwMilliseconds =  0x2
       745 ms     | Sleep()
       764 ms  Sleep()
       764 ms  Sleep() - dwMilliseconds =  0xfffffffe
       764 ms  Sleep() - dwMilliseconds =  0x2
       764 ms     | Sleep()
       780 ms  Sleep()
       780 ms  Sleep() - dwMilliseconds =  0xfffffffe
       780 ms  Sleep() - dwMilliseconds =  0x2
       780 ms     | Sleep()
       795 ms  Sleep()
       795 ms  Sleep() - dwMilliseconds =  0xfffffffe
       795 ms  Sleep() - dwMilliseconds =  0x2
       795 ms     | Sleep()
       811 ms  Sleep()
       811 ms  Sleep() - dwMilliseconds =  0xfffffffe
       811 ms  Sleep() - dwMilliseconds =  0x2
       811 ms     | Sleep()
       837 ms  Sleep()
       837 ms  Sleep() - dwMilliseconds =  0xfffffffe
       837 ms  Sleep() - dwMilliseconds =  0x2
       837 ms     | Sleep()
       864 ms  Sleep()
       864 ms  Sleep() - dwMilliseconds =  0xfffffffe
       864 ms  Sleep() - dwMilliseconds =  0x2
       864 ms     | Sleep()
       881 ms  Sleep()
       881 ms  Sleep() - dwMilliseconds =  0xfffffffe
       881 ms  Sleep() - dwMilliseconds =  0x2
       881 ms     | Sleep()
       897 ms  Sleep()
       897 ms  Sleep() - dwMilliseconds =  0xfffffffe
       897 ms  Sleep() - dwMilliseconds =  0x2
       897 ms     | Sleep()
       912 ms  Sleep()
       912 ms  Sleep() - dwMilliseconds =  0xfffffffe
       912 ms  Sleep() - dwMilliseconds =  0x2
       912 ms     | Sleep()
       935 ms  Sleep()
       935 ms  Sleep() - dwMilliseconds =  0xfffffffe
       935 ms  Sleep() - dwMilliseconds =  0x2
       935 ms     | Sleep()
       965 ms  Sleep()
       965 ms  Sleep() - dwMilliseconds =  0xfffffffe
       965 ms  Sleep() - dwMilliseconds =  0x2
       965 ms     | Sleep()
       990 ms  Sleep()
       990 ms  Sleep() - dwMilliseconds =  0xfffffffe
       990 ms  Sleep() - dwMilliseconds =  0x2
       990 ms     | Sleep()
      1006 ms  Sleep()
      1006 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1006 ms  Sleep() - dwMilliseconds =  0x2
      1006 ms     | Sleep()
      1036 ms  Sleep()
      1036 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1036 ms  Sleep() - dwMilliseconds =  0x2
      1036 ms     | Sleep()
      1065 ms  Sleep()
      1065 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1065 ms  Sleep() - dwMilliseconds =  0x2
      1065 ms     | Sleep()
      1086 ms  Sleep()
      1086 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1086 ms  Sleep() - dwMilliseconds =  0x2
      1086 ms     | Sleep()
      1102 ms  Sleep()
      1102 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1102 ms  Sleep() - dwMilliseconds =  0x2
      1102 ms     | Sleep()
      1118 ms  Sleep()
      1118 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1118 ms  Sleep() - dwMilliseconds =  0x2
      1118 ms     | Sleep()
      1137 ms  Sleep()
      1137 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1137 ms  Sleep() - dwMilliseconds =  0x2
      1137 ms     | Sleep()
      1165 ms  Sleep()
      1165 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1165 ms  Sleep() - dwMilliseconds =  0x2
      1165 ms     | Sleep()
      1188 ms  Sleep()
      1188 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1188 ms  Sleep() - dwMilliseconds =  0x2
      1188 ms     | Sleep()
      1203 ms  Sleep()
      1203 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1203 ms  Sleep() - dwMilliseconds =  0x2
      1203 ms     | Sleep()
      1219 ms  Sleep()
      1219 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1219 ms  Sleep() - dwMilliseconds =  0x2
      1219 ms     | Sleep()
      1238 ms  Sleep()
      1238 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1238 ms  Sleep() - dwMilliseconds =  0x2
      1238 ms     | Sleep()
      1265 ms  Sleep()
      1265 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1265 ms  Sleep() - dwMilliseconds =  0x2
      1265 ms     | Sleep()
      1292 ms  Sleep()
      1292 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1292 ms  Sleep() - dwMilliseconds =  0x2
      1292 ms     | Sleep()
      1308 ms  Sleep()
      1308 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1308 ms  Sleep() - dwMilliseconds =  0x2
      1308 ms     | Sleep()
      1323 ms  Sleep()
      1323 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1323 ms  Sleep() - dwMilliseconds =  0x2
      1323 ms     | Sleep()
      1340 ms  Sleep()
      1340 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1340 ms  Sleep() - dwMilliseconds =  0x2
      1340 ms     | Sleep()
      1366 ms  Sleep()
      1366 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1366 ms  Sleep() - dwMilliseconds =  0x2
      1366 ms     | Sleep()
      1390 ms  Sleep()
      1390 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1390 ms  Sleep() - dwMilliseconds =  0x2
      1390 ms     | Sleep()
      1415 ms  Sleep()
      1415 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1415 ms  Sleep() - dwMilliseconds =  0x2
      1415 ms     | Sleep()
      1441 ms  Sleep()
      1441 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1441 ms  Sleep() - dwMilliseconds =  0x2
      1441 ms     | Sleep()
      1465 ms  Sleep()
      1465 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1465 ms  Sleep() - dwMilliseconds =  0x2
      1465 ms     | Sleep()
      1492 ms  Sleep()
      1492 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1492 ms  Sleep() - dwMilliseconds =  0x2
      1492 ms     | Sleep()
      1507 ms  Sleep()
      1507 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1507 ms  Sleep() - dwMilliseconds =  0x2
      1507 ms     | Sleep()
      1523 ms  Sleep()
      1523 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1523 ms  Sleep() - dwMilliseconds =  0x2
      1523 ms     | Sleep()
      1542 ms  Sleep()
      1542 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1542 ms  Sleep() - dwMilliseconds =  0x2
      1542 ms     | Sleep()
      1566 ms  Sleep()
      1566 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1566 ms  Sleep() - dwMilliseconds =  0x2
      1566 ms     | Sleep()
      1593 ms  Sleep()
      1593 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1593 ms  Sleep() - dwMilliseconds =  0x2
      1593 ms     | Sleep()
      1609 ms  Sleep()
      1609 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1609 ms  Sleep() - dwMilliseconds =  0x2
      1609 ms     | Sleep()
      1624 ms  Sleep()
      1624 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1624 ms  Sleep() - dwMilliseconds =  0x2
      1624 ms     | Sleep()
      1644 ms  Sleep()
      1644 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1644 ms  Sleep() - dwMilliseconds =  0x2
      1644 ms     | Sleep()
    Ok, I'm Up! The flag is: cGljb0NURnt3NGtlX20zX3VwX3cxdGhfZnIxZGFfZjI3YWNjMzh9
      1666 ms  Sleep()
      1666 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1666 ms  Sleep() - dwMilliseconds =  0x2
      1666 ms     | Sleep()
      1694 ms  Sleep()
      1694 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1694 ms  Sleep() - dwMilliseconds =  0x2
      1694 ms     | Sleep()
      1710 ms  Sleep()
      1710 ms  Sleep() - dwMilliseconds =  0xfffffffe
      1710 ms  Sleep() - dwMilliseconds =  0x2
      1710 ms     | Sleep()
    Process terminated

Looking like a base64 encoded string, we run it through [base64 Decode and Encode](https://base64.decode.org) to decode the flag:

    picoCTF{...........redacted.............}

Where the actual flag value has been redacted for the purposes of this write up.

## Notes ##

When unzipping the challenge binary, Microsoft Defender Antivirus reports and blocks this binary as:

    Trojan:Win64/TerraLoader.A!MTB

Further Microsoft Defender exclusions were required for running Python's `pip`.
